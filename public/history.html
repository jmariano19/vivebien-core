<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>CareLog - Timeline</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23885955'%3E%3Cpath d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F9F6F0;
      --card-bg: #FFFFFF;
      --primary: #2E915E;
      --primary-dark: #247a4d;
      --btn-color: #216F64;
      --text: #373737;
      --text-dark: #000000;
      --muted: rgba(0,0,0,0.45);
      --status-active: #2E915E;
      --status-improving: #3B82F6;
      --status-resolved: #9CA3AF;
      --danger: #DC2626;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 402px;
      min-height: 100vh;
      padding: 16px 22px 40px;
    }

    /* ===== TOP BAR ===== */
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0 16px;
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 100;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      font-weight: 400;
      color: var(--muted);
      text-decoration: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .back-link:hover { color: var(--text); }
    .back-link svg {
      width: 7px;
      height: 12px;
      flex-shrink: 0;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: 'Lora', Georgia, serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: -0.5px;
    }

    /* ===== HEADER ===== */
    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .header h1 {
      font-family: 'Lora', Georgia, serif;
      font-size: 32px;
      font-weight: 500;
      color: var(--text);
      line-height: 36px;
    }

    /* ===== FILTER TABS ===== */
    .tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      margin-bottom: 28px;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }

    .tab {
      padding: 10px 20px;
      border-radius: 10px;
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      border: none;
      background: #E0D8CD;
      color: #6B5D4F;
      transition: all 0.2s;
    }
    .tab:hover { background: #d6cec2; }
    .tab.active {
      background: var(--btn-color);
      color: white;
    }

    /* ===== TIMELINE ===== */
    .timeline {
      position: relative;
      padding-left: 40px;
    }

    /* Vertical line */
    .timeline::before {
      content: '';
      position: absolute;
      left: 14px;
      top: 8px;
      bottom: 8px;
      width: 2px;
      background: #e0dbd4;
    }

    /* Date group */
    .timeline-group {
      margin-bottom: 24px;
    }

    .timeline-date-row {
      display: flex;
      align-items: center;
      gap: 0;
      margin-bottom: 12px;
      position: relative;
    }

    .timeline-emoji {
      position: absolute;
      left: -36px;
      top: -2px;
      font-size: 22px;
      z-index: 2;
    }

    .timeline-date-label {
      font-family: 'Outfit', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    /* Snapshot card */
    .snapshot-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 18px 20px;
      margin-bottom: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .snapshot-card.expanded {
      border-color: rgba(46, 145, 94, 0.61);
    }

    .snapshot-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }
    .snapshot-card-icon { font-size: 28px; flex-shrink: 0; }
    .snapshot-card-title {
      font-family: 'Lora', Georgia, serif;
      font-size: 18px;
      font-weight: 500;
      color: var(--text-dark);
    }

    .snapshot-card-status {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-family: 'Outfit', sans-serif;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-top: 2px;
    }
    .snapshot-card-status.active { background: rgba(46,145,94,0.15); color: var(--status-active); }
    .snapshot-card-status.improving { background: rgba(59,130,246,0.15); color: var(--status-improving); }
    .snapshot-card-status.resolved { background: rgba(156,163,175,0.15); color: var(--status-resolved); }

    /* See details toggle */
    .snapshot-card-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
    }

    .see-details-link {
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: #9a9a9a;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .see-details-link svg {
      width: 10px;
      height: 6px;
      flex-shrink: 0;
    }

    /* Expanded content */
    .snapshot-card-body {
      display: none;
      margin-top: 12px;
    }
    .snapshot-card.expanded .snapshot-card-body { display: block; }
    .snapshot-card.expanded .snapshot-collapsed-footer { display: none; }

    .snapshot-paragraph {
      font-family: 'Outfit', sans-serif;
      font-size: 16px;
      font-weight: 300;
      color: var(--text-dark);
      line-height: 25px;
      margin-top: 8px;
    }

    .snapshot-card-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
    }
    .snapshot-card-actions-left {
      display: flex;
      gap: 16px;
    }
    .snapshot-card-actions-left a {
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: #2d915f;
      text-decoration: none;
      cursor: pointer;
    }

    /* Loading + Empty */
    .loading { text-align: center; padding: 60px 20px; }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid #E5E0D8;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading p { font-family: 'Outfit', sans-serif; color: var(--text-dark); opacity: 0.5; font-size: 15px; }

    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }
    .empty-state h2 { font-family: 'Lora', Georgia, serif; font-size: 20px; font-weight: 500; margin-bottom: 8px; }
    .empty-state p { font-family: 'Outfit', sans-serif; color: var(--muted); font-size: 15px; line-height: 22px; max-width: 260px; margin: 0 auto; }
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <a class="back-link" id="backButton">
        <svg viewBox="0 0 7 12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 1L1 6L6 11"/></svg>
        <span id="backText">Back to summary</span>
      </a>
      <span class="brand">CareLog</span>
    </div>

    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p id="loadingText">Loading timeline...</p>
      </div>
    </div>
  </div>

  <script>
    const pathParts = window.location.pathname.split('/');
    const userId = pathParts[pathParts.length - 1];

    const i18n = {
      es: {
        title: 'Tu timeline',
        all: 'ALL',
        loading: 'Cargando timeline...',
        back: 'Volver al resumen',
        emptyTitle: 'Sin historial a√∫n',
        emptyText: 'Tu historial de salud aparecer√° aqu√≠ a medida que contin√∫es tus conversaciones.',
        seeDetails: 'See details',
        seeLess: 'See less',
        status: { active: 'Vigente', improving: 'Mejorando', resolved: 'Resuelto' },
        update: 'Update',
        edit: 'Edit',
        days: ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'],
        months: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
        today: 'Hoy',
        yesterday: 'Ayer'
      },
      en: {
        title: 'Your timeline',
        all: 'ALL',
        loading: 'Loading timeline...',
        back: 'Back to summary',
        emptyTitle: 'No history yet',
        emptyText: 'Your health timeline will appear here as you continue your conversations.',
        seeDetails: 'See details',
        seeLess: 'See less',
        status: { active: 'Ongoing', improving: 'Improving', resolved: 'Resolved' },
        update: 'Update',
        edit: 'Edit',
        days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
        months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        today: 'Today',
        yesterday: 'Yesterday'
      },
      pt: {
        title: 'Sua timeline',
        all: 'TODOS',
        loading: 'Carregando timeline...',
        back: 'Voltar ao resumo',
        emptyTitle: 'Sem hist√≥rico ainda',
        emptyText: 'Sua timeline de sa√∫de aparecer√° aqui conforme voc√™ continua suas conversas.',
        seeDetails: 'Ver detalhes',
        seeLess: 'Ver menos',
        status: { active: 'Em andamento', improving: 'Melhorando', resolved: 'Resolvido' },
        update: 'Atualizar',
        edit: 'Editar',
        days: ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'],
        months: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
        today: 'Hoje',
        yesterday: 'Ontem'
      },
      fr: {
        title: 'Votre timeline',
        all: 'TOUS',
        loading: 'Chargement de la timeline...',
        back: 'Retour au r√©sum√©',
        emptyTitle: "Pas encore d'historique",
        emptyText: 'Votre timeline de sant√© appara√Ætra ici au fur et √† mesure de vos conversations.',
        seeDetails: 'Voir d√©tails',
        seeLess: 'Voir moins',
        status: { active: 'En cours', improving: 'En am√©lioration', resolved: 'R√©solu' },
        update: 'Mettre √† jour',
        edit: 'Modifier',
        days: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'],
        months: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'],
        today: "Aujourd'hui",
        yesterday: 'Hier'
      }
    };

    let lang = 'en';
    let concerns = [];
    let allSnapshots = [];
    let selectedConcernId = null;

    function getLang() { return i18n[lang] || i18n.en; }

    function getIconForConcern(title) {
      const l = title.toLowerCase();
      if (l.includes('eye') || l.includes('ojo') || l.includes('sty')) return 'üëÅÔ∏è';
      if (l.includes('head') || l.includes('cabeza') || l.includes('migraine')) return 'ü§ï';
      if (l.includes('stomach') || l.includes('est√≥mago') || l.includes('digestion')) return 'ü§¢';
      if (l.includes('throat') || l.includes('garganta') || l.includes('cold')) return 'ü§ß';
      if (l.includes('back') || l.includes('espalda') || l.includes('pain') || l.includes('dolor')) return 'üò∞';
      if (l.includes('skin') || l.includes('piel') || l.includes('rash')) return 'ü©π';
      if (l.includes('sleep') || l.includes('sue√±o') || l.includes('insomnia')) return 'üò¥';
      if (l.includes('med') || l.includes('medicin') || l.includes('pill')) return 'üíä';
      if (l.includes('routine') || l.includes('rutina')) return 'üò¥';
      return 'üìã';
    }

    function formatTimelineDate(dateStr) {
      const t = getLang();
      const d = new Date(dateStr);
      const now = new Date();
      const dayName = t.days[d.getDay()];
      const monthName = t.months[d.getMonth()];
      const dayNum = d.getDate();

      if (d.toDateString() === now.toDateString()) {
        return `${t.today}, ${dayName} ${monthName} ${dayNum}`;
      }
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      if (d.toDateString() === yesterday.toDateString()) {
        return `${t.yesterday}, ${dayName} ${monthName} ${dayNum}`;
      }
      return `${dayName}, ${monthName} ${dayNum}`;
    }

    function cleanSnapshotText(text) {
      if (!text) return '';
      return text
        .replace(/^#+\s*.+\n*/gm, '')
        .replace(/^\*\*[^*]+Health Notes?\*\*\n*/gm, '')
        .replace(/^---+\n*/gm, '')
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        .replace(/^(?:Main concern|Concern|Motivo|Queixa|Motif)[:\s]*/gim, '')
        .replace(/^(?:Started|Inicio|In√≠cio|D√©but)[:\s]*/gim, '')
        .replace(/^(?:What helps|Helps|Mejora con|Melhora com|Am√©liore)[:\s]*/gim, '')
        .replace(/^(?:What worsens|Worsens|Empeora con|Piora com|Aggrave)[:\s]*/gim, '')
        .replace(/^(?:Medications|Medicamentos|M√©dicaments|Meds)[:\s]*/gim, '')
        .replace(/^(?:Location|Ubicaci√≥n|Localiza√ß√£o)[:\s]*/gim, '')
        .replace(/^(?:Symptoms|S√≠ntomas|Sintomas|Notes)[:\s]*/gim, '')
        .replace(/Patient reports (having )?/gi, '')
        .replace(/\bpatient\b/gi, '')
        .replace(/\breports\b/gi, '')
        .replace(/\n{2,}/g, '\n')
        .trim();
    }

    function buildParagraph(text) {
      const cleaned = cleanSnapshotText(text);
      const lines = cleaned.split('\n').map(l => l.trim()).filter(l => l.length > 1);
      return lines.join('. ').replace(/\.\./g, '.').replace(/\.\s*\./g, '.');
    }

    // ===== RENDER =====
    function renderPage() {
      const t = getLang();
      const content = document.getElementById('content');

      // Filter snapshots
      const snapshots = selectedConcernId === null
        ? allSnapshots
        : allSnapshots.filter(s => s.concernId === selectedConcernId);

      // Sort descending
      snapshots.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Group by date (day)
      const groups = {};
      snapshots.forEach(s => {
        const dateKey = new Date(s.date).toDateString();
        if (!groups[dateKey]) groups[dateKey] = { date: s.date, items: [] };
        groups[dateKey].items.push(s);
      });

      // Build tabs
      let tabsHtml = `<div class="tab ${selectedConcernId === null ? 'active' : ''}" data-id="all">${t.all}</div>`;
      concerns.forEach(c => {
        const isActive = selectedConcernId === c.id;
        tabsHtml += `<div class="tab ${isActive ? 'active' : ''}" data-id="${c.id}">${c.title.toUpperCase()}</div>`;
      });

      // Build timeline
      let timelineHtml = '';
      const dateKeys = Object.keys(groups);

      if (dateKeys.length === 0) {
        timelineHtml = `<div class="empty-state">
          <div class="icon">üìã</div>
          <h2>${t.emptyTitle}</h2>
          <p>${t.emptyText}</p>
        </div>`;
      } else {
        timelineHtml = '<div class="timeline">';
        dateKeys.forEach(dateKey => {
          const group = groups[dateKey];
          const dateLabel = formatTimelineDate(group.date);

          timelineHtml += '<div class="timeline-group">';
          timelineHtml += `<div class="timeline-date-row">
            <span class="timeline-emoji">üóÇÔ∏è</span>
            <span class="timeline-date-label">${dateLabel}</span>
          </div>`;

          group.items.forEach(snapshot => {
            const concern = concerns.find(c => c.id === snapshot.concernId);
            if (!concern) return;

            const icon = concern.icon || getIconForConcern(concern.title);
            const status = snapshot.status || concern.status || 'active';
            const statusLabel = t.status[status] || status;
            const paragraph = buildParagraph(snapshot.summary || '');
            const cardId = `snap-${snapshot.id || snapshot.date}`;

            timelineHtml += `<div class="snapshot-card" id="${cardId}" onclick="toggleCard('${cardId}')">
              <div class="snapshot-card-header">
                <div class="snapshot-card-icon">${icon}</div>
                <div class="snapshot-card-title">${concern.title}</div>
              </div>
              <span class="snapshot-card-status ${status}">${statusLabel}</span>

              <div class="snapshot-collapsed-footer snapshot-card-footer">
                <button class="see-details-link" onclick="event.stopPropagation(); toggleCard('${cardId}')">
                  ${t.seeDetails} <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1L5 5L9 1"/></svg>
                </button>
              </div>

              <div class="snapshot-card-body">
                <div class="snapshot-paragraph">${paragraph}</div>
                <div class="snapshot-card-actions">
                  <div class="snapshot-card-actions-left">
                    <a onclick="event.stopPropagation(); editConcern('${snapshot.concernId}')">${t.edit}</a>
                    <a onclick="event.stopPropagation(); updateConcern('${snapshot.concernId}')">${t.update}</a>
                  </div>
                  <button class="see-details-link" onclick="event.stopPropagation(); toggleCard('${cardId}')">
                    ${t.seeLess} <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="transform:rotate(180deg)"><path d="M1 1L5 5L9 1"/></svg>
                  </button>
                </div>
              </div>
            </div>`;
          });

          timelineHtml += '</div>';
        });
        timelineHtml += '</div>';
      }

      content.innerHTML = `
        <div class="header"><h1>${t.title}</h1></div>
        <div class="tabs">${tabsHtml}</div>
        ${timelineHtml}
      `;

      attachListeners();
    }

    function attachListeners() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const id = tab.dataset.id;
          selectedConcernId = id === 'all' ? null : id;
          renderPage();
        });
      });
    }

    function toggleCard(cardId) {
      const card = document.getElementById(cardId);
      if (!card) return;
      card.classList.toggle('expanded');
    }

    function editConcern(concernId) {
      window.location.href = `/suggest/${userId}?concernId=${concernId}&returnTo=history`;
    }

    function updateConcern(concernId) {
      window.location.href = `/suggest/${userId}?concernId=${concernId}&returnTo=history`;
    }

    // ===== LOAD DATA =====
    async function loadTimeline() {
      const t = getLang();
      document.getElementById('loadingText').textContent = t.loading;

      try {
        const response = await fetch(`/api/concerns/${userId}`);
        if (!response.ok) throw new Error('Failed to load');

        const data = await response.json();
        lang = data.language || 'en';
        concerns = data.concerns || [];
        document.getElementById('backText').textContent = getLang().back;

        allSnapshots = [];
        for (const concern of concerns) {
          const histRes = await fetch(`/api/concerns/${userId}/${concern.id}/history`);
          if (histRes.ok) {
            const histData = await histRes.json();
            const snapshots = histData.snapshots || [];
            snapshots.forEach(snapshot => {
              allSnapshots.push({
                concernId: concern.id,
                date: snapshot.createdAt,
                summary: snapshot.content,
                changeType: snapshot.changeType,
                status: snapshot.status,
                id: snapshot.id,
              });
            });
          }
        }

        // Deduplicate: keep only the latest snapshot per concern per day
        // This prevents showing 5+ near-identical "Back pain" cards for the same day
        const deduped = {};
        allSnapshots
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .forEach(s => {
            const dayKey = new Date(s.date).toDateString() + '|' + s.concernId;
            if (!deduped[dayKey]) {
              deduped[dayKey] = s; // Keep the latest (first after sort desc)
            }
          });
        allSnapshots = Object.values(deduped);

        // Check URL for concern filter
        const urlParams = new URLSearchParams(window.location.search);
        const filterConcern = urlParams.get('concern');
        if (filterConcern && concerns.find(c => c.id === filterConcern)) {
          selectedConcernId = filterConcern;
        } else {
          selectedConcernId = null;
        }

        renderPage();
      } catch (error) {
        console.error('Error:', error);
        renderPage();
      }
    }

    document.getElementById('backButton').addEventListener('click', () => {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = `/${userId}`;
      }
    });

    if (userId && userId !== 'history') {
      loadTimeline();
    } else {
      renderPage();
    }
  </script>
</body>
</html>
